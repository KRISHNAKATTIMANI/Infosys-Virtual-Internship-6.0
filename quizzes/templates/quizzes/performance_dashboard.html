<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Performance Dashboard</title>

    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
      body {
        font-family: Arial, sans-serif;
        background: #f7f8fa;
        padding: 20px;
      }

      h1 {
        margin-bottom: 20px;
      }

      .dashboard {
        max-width: 1200px;
        margin: auto;
      }

      /* ================= SUMMARY CARDS ================= */
      .cards {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: 20px;
        margin-bottom: 30px;
      }

      .card {
        background: #ffffff;
        padding: 16px;
        border-radius: 10px;
        text-align: center;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
      }

      .card h3 {
        font-size: 14px;
        color: #555;
        margin-bottom: 8px;
      }

      .card p {
        font-size: 22px;
        font-weight: bold;
        margin: 0;
        color: #111;
      }

      /* ================= CHART GRID ================= */
      .chart-grid {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 24px;
        margin-top: 20px;
      }

      .chart-card {
        background: #ffffff;
        padding: 20px;
        border-radius: 12px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
      }

      .chart-title {
        font-size: 16px;
        font-weight: 600;
        margin-bottom: 12px;
        color: #333;
      }

      canvas {
        width: 100% !important;
        height: 260px !important;
      }

      /* ================= INSIGHTS ================= */
      .insights {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 16px;
        margin-top: 30px;
      }

      .insight {
        background: #eef2ff;
        padding: 14px 16px;
        border-left: 4px solid #6366f1;
        border-radius: 6px;
        font-size: 14px;
      }

      /* ================= RESPONSIVE ================= */
      @media (max-width: 900px) {
        .cards {
          grid-template-columns: repeat(2, 1fr);
        }
        .chart-grid {
          grid-template-columns: 1fr;
        }
        .insights {
          grid-template-columns: 1fr;
        }
      }
    </style>
  </head>

  <body>
    <div class="dashboard">
      <a
        href="{% url 'quizzes:download_performance_pdf' %}"
        style="
          float: right;
          background: #4f46e5;
          color: white;
          padding: 8px 14px;
          border-radius: 6px;
          text-decoration: none;
        "
      >
        ‚¨á Download PDF
      </a>

      <h1>üìä Performance Dashboard</h1>

      <!-- ================= SUMMARY ================= -->
      <div class="cards">
        <div class="card">
          <div class="card-title">üî• Daily Streak</div>
          <div class="card-desc">{{ streak }} day(s)</div>
        </div>
        <div class="card">
          <h3>Total Quizzes</h3>
          <p>{{ total_quizzes }}</p>
        </div>
        <div class="card">
          <h3>Average Score</h3>
          <p>{{ avg_score }}%</p>
        </div>
        <div class="card">
          <h3>Overall Accuracy</h3>
          <p>{{ overall_accuracy }}%</p>
        </div>
        <div class="card">
          <h3>Avg Time / Question</h3>
          <p>{{ avg_time_per_question }}s</p>
        </div>
      </div>

      <!-- ================= CHARTS ================= -->
      <div class="chart-grid">
        <div class="chart-card">
          <div class="chart-title">Category Distribution</div>
          <canvas id="categoryPie"></canvas>
        </div>

        <div class="chart-card">
          <div class="chart-title">Performance by Difficulty</div>
          <canvas id="difficultyBar"></canvas>
        </div>

        <div class="chart-card">
          <div class="chart-title">Accuracy by Topic</div>
          <canvas id="subcategoryBar"></canvas>
        </div>

        <div class="chart-card">
          <div class="chart-title">Progress Over Time</div>
          <canvas id="timeLine"></canvas>
        </div>
      </div>

      <h2 style="margin-top: 40px">Topic Strength Analysis</h2>

      <div class="chart-grid">
        <div class="chart-card">
          <div class="chart-title">‚úÖ Strong Topics</div>
          {% if strong_topics %}
          <ul>
            {% for t in strong_topics %}
            <li>{{ t.subcategory }} ‚Äî {{ t.accuracy }}%</li>
            {% endfor %}
          </ul>
          {% else %}
          <p>No strong topics yet.</p>
          {% endif %}
        </div>

        <div class="chart-card">
          <div class="chart-title">‚ö†Ô∏è Weak Topics</div>
          {% if weak_topics %}
          <ul>
            {% for t in weak_topics %}
            <li>{{ t.subcategory }} ‚Äî {{ t.accuracy }}%</li>
            {% endfor %}
          </ul>
          {% else %}
          <p>No weak topics üéâ</p>
          {% endif %}
        </div>
      </div>

      <h2>ü§ñ AI Learning Feedback</h2>

      <div class="chart-card" style="background: #f8fafc">
        <pre style="white-space: pre-wrap; font-family: inherit">
{{ ai_feedback }}</pre
        >
      </div>

      <!-- ================= INSIGHTS ================= -->
      <h2 style="margin-top: 40px">Insights</h2>
      <div class="insights">
        {% for insight in insights %}
        <div class="insight">{{ insight }}</div>
        {% endfor %}
      </div>
    </div>

    <script>
      Chart.defaults.maintainAspectRatio = false;

      /* -------- CATEGORY PIE -------- */
      new Chart(document.getElementById('categoryPie'), {
        type: 'pie',
        data: {
          labels: [{% for c in category_distribution %}'{{ c.category__name }}',{% endfor %}],
          datasets: [{
            data: [{% for c in category_distribution %}{{ c.quiz_count }},{% endfor %}],
            backgroundColor: ['#6366f1', '#22c55e', '#f97316']
          }]
        }
      });

      /* -------- SUBCATEGORY BAR -------- */
      new Chart(document.getElementById('subcategoryBar'), {
        type: 'bar',
        data: {
          labels: [{% for s in subcategory_accuracy %}'{{ s.subcategory }}',{% endfor %}],
          datasets: [{
            label: 'Accuracy (%)',
            data: [{% for s in subcategory_accuracy %}{{ s.accuracy }},{% endfor %}],
            backgroundColor: '#4ade80'
          }]
        },
        options: {
          scales: {
            y: { beginAtZero: true, max: 100 }
          }
        }
      });

      /* -------- DIFFICULTY BAR -------- */
      new Chart(document.getElementById('difficultyBar'), {
        type: 'bar',
        data: {
          labels: [{% for d in difficulty_performance %}'{{ d.difficulty }}',{% endfor %}],
          datasets: [{
            label: 'Average Score (%)',
            data: [{% for d in difficulty_performance %}{{ d.avg_score|floatformat:2 }},{% endfor %}],
            backgroundColor: '#60a5fa'
          }]
        },
        options: {
          scales: {
            y: { beginAtZero: true, max: 100 }
          }
        }
      });

      /* -------- PERFORMANCE OVER TIME -------- */
      new Chart(document.getElementById('timeLine'), {
        type: 'line',
        data: {
          labels: [{% for p in performance_over_time %}'{{ p.date }}',{% endfor %}],
          datasets: [{
            label: 'Avg Score (%)',
            data: [{% for p in performance_over_time %}{{ p.avg_score|floatformat:2 }},{% endfor %}],
            borderColor: '#f43f5e',
            tension: 0.3
          }]
        }
      });
    </script>
  </body>
</html>
