{% load static %}
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Performance Dashboard ‚Äî AI Quiz Hub</title>

    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Poppins:wght@400;500;600;700;800&display=swap"
      rel="stylesheet"
    />

    <!-- Icons -->
    <link
      href="https://cdn.jsdelivr.net/npm/remixicon@4.0.0/fonts/remixicon.css"
      rel="stylesheet"
    />

    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
        background: linear-gradient(135deg, #0a1628 0%, #0f172a 50%, #1e293b 100%);
        min-height: 100vh;
        color: #e2e8f0;
        position: relative;
      }

      body::before {
        content: '';
        position: fixed;
        inset: 0;
        background: 
          radial-gradient(ellipse at 20% 20%, rgba(245, 158, 11, 0.08) 0%, transparent 40%),
          radial-gradient(ellipse at 80% 80%, rgba(59, 130, 246, 0.05) 0%, transparent 40%);
        pointer-events: none;
        z-index: -1;
      }

      /* Navbar */
      .navbar {
        background: rgba(15, 23, 42, 0.9);
        backdrop-filter: blur(20px);
        padding: 1rem 2rem;
        display: flex;
        justify-content: space-between;
        align-items: center;
        border-bottom: 1px solid rgba(245, 158, 11, 0.15);
        position: sticky;
        top: 0;
        z-index: 100;
      }

      .nav-brand {
        font-family: 'Poppins', sans-serif;
        font-size: 1.5rem;
        font-weight: 800;
        background: linear-gradient(135deg, #f59e0b, #fbbf24);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        text-decoration: none;
      }

      .nav-links {
        display: flex;
        gap: 0.5rem;
      }

      .nav-link {
        color: #94a3b8;
        text-decoration: none;
        padding: 0.625rem 1.25rem;
        border-radius: 0.625rem;
        font-weight: 500;
        transition: all 0.3s ease;
      }

      .nav-link:hover {
        color: #fbbf24;
        background: rgba(245, 158, 11, 0.1);
      }

      /* Container */
      .dashboard {
        max-width: 1200px;
        margin: 0 auto;
        padding: 2rem;
      }

      /* Header */
      .page-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 2rem;
      }

      .page-title {
        display: flex;
        align-items: center;
        gap: 0.75rem;
      }

      .page-title h1 {
        font-family: 'Poppins', sans-serif;
        font-size: 2rem;
        font-weight: 800;
        color: #f8fafc;
      }

      .page-title i {
        font-size: 2rem;
        color: #fbbf24;
      }

      .download-btn {
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.75rem 1.5rem;
        background: linear-gradient(135deg, #f59e0b, #fbbf24);
        border: none;
        border-radius: 0.75rem;
        color: #0f172a;
        font-weight: 600;
        text-decoration: none;
        transition: all 0.3s ease;
        box-shadow: 0 4px 20px rgba(245, 158, 11, 0.4);
      }

      .download-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 30px rgba(245, 158, 11, 0.5);
      }

      /* Back Link */
      .back-link {
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        color: #94a3b8;
        text-decoration: none;
        margin-bottom: 1.5rem;
        font-weight: 500;
        transition: color 0.3s ease;
      }

      .back-link:hover {
        color: #fbbf24;
      }

      /* Summary Cards */
      .cards {
        display: grid;
        grid-template-columns: repeat(5, 1fr);
        gap: 1rem;
        margin-bottom: 2rem;
      }

      .card {
        background: rgba(30, 41, 59, 0.7);
        backdrop-filter: blur(10px);
        border: 1px solid rgba(245, 158, 11, 0.15);
        border-radius: 1rem;
        padding: 1.5rem;
        text-align: center;
        transition: all 0.3s ease;
      }

      .card:hover {
        transform: translateY(-5px);
        border-color: rgba(245, 158, 11, 0.4);
        box-shadow: 0 10px 30px rgba(245, 158, 11, 0.2);
      }

      .card h3 {
        font-size: 0.75rem;
        color: #94a3b8;
        text-transform: uppercase;
        letter-spacing: 0.05em;
        margin-bottom: 0.5rem;
      }

      .card p {
        font-size: 1.75rem;
        font-weight: 700;
        background: linear-gradient(135deg, #f59e0b, #fbbf24);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        margin: 0;
      }

      .card-icon {
        font-size: 2rem;
        margin-bottom: 0.5rem;
      }

      /* Chart Grid */
      .chart-grid {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 1.5rem;
        margin-bottom: 2rem;
      }

      .chart-card {
        background: rgba(30, 41, 59, 0.7);
        backdrop-filter: blur(10px);
        border: 1px solid rgba(245, 158, 11, 0.15);
        border-radius: 1rem;
        padding: 1.5rem;
      }

      .chart-title {
        font-size: 1rem;
        font-weight: 600;
        color: #f8fafc;
        margin-bottom: 1rem;
        display: flex;
        align-items: center;
        gap: 0.5rem;
      }

      .chart-title i {
        color: #fbbf24;
      }

      canvas {
        width: 100% !important;
        height: 260px !important;
      }

      /* Section Headers */
      .section-header {
        font-family: 'Poppins', sans-serif;
        font-size: 1.5rem;
        font-weight: 700;
        color: #f8fafc;
        margin: 2rem 0 1rem;
        display: flex;
        align-items: center;
        gap: 0.5rem;
      }

      .section-header i {
        color: #fbbf24;
      }

      /* Topic Lists */
      .topic-list {
        list-style: none;
        padding: 0;
        margin: 0;
      }

      .topic-list li {
        padding: 0.75rem 0;
        border-bottom: 1px solid rgba(148, 163, 184, 0.2);
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .topic-list li:last-child {
        border-bottom: none;
      }

      .topic-name {
        color: #e2e8f0;
        font-weight: 500;
      }

      .topic-score {
        font-weight: 600;
        padding: 0.25rem 0.75rem;
        border-radius: 999px;
        font-size: 0.875rem;
      }

      .score-high {
        background: rgba(34, 197, 94, 0.2);
        color: #4ade80;
      }

      .score-low {
        background: rgba(239, 68, 68, 0.2);
        color: #f87171;
      }

      .empty-text {
        color: #94a3b8;
        font-style: italic;
        padding: 1rem 0;
      }

      /* AI Feedback */
      .ai-feedback-card {
        background: linear-gradient(135deg, rgba(245, 158, 11, 0.1), rgba(251, 191, 36, 0.05));
        border: 1px solid rgba(245, 158, 11, 0.25);
        border-radius: 1rem;
        padding: 1.5rem;
        margin-bottom: 2rem;
      }

      .ai-feedback-card pre {
        white-space: pre-wrap;
        font-family: inherit;
        color: #e2e8f0;
        line-height: 1.6;
        margin: 0;
      }

      /* Insights */
      .insights {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 1rem;
      }

      .insight {
        background: rgba(245, 158, 11, 0.1);
        border-left: 4px solid #fbbf24;
        border-radius: 0.5rem;
        padding: 1rem 1.25rem;
        color: #e2e8f0;
        font-size: 0.9375rem;
      }

      /* Responsive */
      @media (max-width: 1024px) {
        .cards {
          grid-template-columns: repeat(3, 1fr);
        }
      }

      @media (max-width: 768px) {
        .dashboard {
          padding: 1rem;
        }

        .cards {
          grid-template-columns: repeat(2, 1fr);
        }

        .chart-grid {
          grid-template-columns: 1fr;
        }

        .insights {
          grid-template-columns: 1fr;
        }

        .page-header {
          flex-direction: column;
          gap: 1rem;
          align-items: flex-start;
        }
      }
    </style>
  </head>

  <body>
    <!-- Navbar -->
    <nav class="navbar">
      <a href="{% url 'quizzes:dashboard' %}" class="nav-brand">AI Quiz Hub</a>
      <div class="nav-links">
        <a href="{% url 'quizzes:dashboard' %}" class="nav-link">Dashboard</a>
        <a href="{% url 'accounts:profile' %}" class="nav-link">Profile</a>
        <a href="{% url 'accounts:logout' %}" class="nav-link">Logout</a>
      </div>
    </nav>

    <div class="dashboard">
      <a href="{% url 'quizzes:dashboard' %}" class="back-link">
        <i class="ri-arrow-left-line"></i>
        Back to Dashboard
      </a>

      <div class="page-header">
        <div class="page-title">
          <i class="ri-bar-chart-grouped-line"></i>
          <h1>Performance Dashboard</h1>
        </div>
        <a href="{% url 'quizzes:download_performance_pdf' %}" class="download-btn">
          <i class="ri-download-2-line"></i>
          Download PDF
        </a>
      </div>

      <!-- Summary Cards -->
      <div class="cards">
        <div class="card">
          <div class="card-icon">üî•</div>
          <h3>Daily Streak</h3>
          <p>{{ streak }}</p>
        </div>
        <div class="card">
          <div class="card-icon">üìù</div>
          <h3>Total Quizzes</h3>
          <p>{{ total_quizzes }}</p>
        </div>
        <div class="card">
          <div class="card-icon">‚≠ê</div>
          <h3>Average Score</h3>
          <p>{{ avg_score }}%</p>
        </div>
        <div class="card">
          <div class="card-icon">üéØ</div>
          <h3>Overall Accuracy</h3>
          <p>{{ overall_accuracy }}%</p>
        </div>
        <div class="card">
          <div class="card-icon">‚è±Ô∏è</div>
          <h3>Avg Time/Question</h3>
          <p>{{ avg_time_per_question }}s</p>
        </div>
      </div>

      <!-- Charts -->
      <div class="chart-grid">
        <div class="chart-card">
          <div class="chart-title">
            <i class="ri-pie-chart-line"></i>
            Category Distribution
          </div>
          <canvas id="categoryPie"></canvas>
        </div>

        <div class="chart-card">
          <div class="chart-title">
            <i class="ri-bar-chart-horizontal-line"></i>
            Performance by Difficulty
          </div>
          <canvas id="difficultyBar"></canvas>
        </div>

        <div class="chart-card">
          <div class="chart-title">
            <i class="ri-bar-chart-2-line"></i>
            Accuracy by Topic
          </div>
          <canvas id="subcategoryBar"></canvas>
        </div>

        <div class="chart-card">
          <div class="chart-title">
            <i class="ri-line-chart-line"></i>
            Progress Over Time
          </div>
          <canvas id="timeLine"></canvas>
        </div>
      </div>

      <!-- Topic Strength Analysis -->
      <h2 class="section-header">
        <i class="ri-focus-3-line"></i>
        Topic Strength Analysis
      </h2>

      <div class="chart-grid">
        <div class="chart-card">
          <div class="chart-title">
            <i class="ri-checkbox-circle-line"></i>
            Strong Topics
          </div>
          {% if strong_topics %}
          <ul class="topic-list">
            {% for t in strong_topics %}
            <li>
              <span class="topic-name">{{ t.subcategory }}</span>
              <span class="topic-score score-high">{{ t.accuracy }}%</span>
            </li>
            {% endfor %}
          </ul>
          {% else %}
          <p class="empty-text">No strong topics yet. Keep practicing!</p>
          {% endif %}
        </div>

        <div class="chart-card">
          <div class="chart-title">
            <i class="ri-error-warning-line"></i>
            Weak Topics
          </div>
          {% if weak_topics %}
          <ul class="topic-list">
            {% for t in weak_topics %}
            <li>
              <span class="topic-name">{{ t.subcategory }}</span>
              <span class="topic-score score-low">{{ t.accuracy }}%</span>
            </li>
            {% endfor %}
          </ul>
          {% else %}
          <p class="empty-text">No weak topics ‚Äî great job! üéâ</p>
          {% endif %}
        </div>
      </div>

      <!-- AI Feedback -->
      <h2 class="section-header">
        <i class="ri-robot-line"></i>
        AI Learning Feedback
      </h2>

      <div class="ai-feedback-card">
        <pre>{{ ai_feedback }}</pre>
      </div>

      <!-- Insights -->
      <h2 class="section-header">
        <i class="ri-lightbulb-line"></i>
        Insights
      </h2>

      <div class="insights">
        {% for insight in insights %}
        <div class="insight">{{ insight }}</div>
        {% endfor %}
      </div>
    </div>

    <script>
      // Chart.js dark theme configuration
      Chart.defaults.color = '#94a3b8';
      Chart.defaults.borderColor = 'rgba(255, 255, 255, 0.1)';
      Chart.defaults.maintainAspectRatio = false;

      /* -------- CATEGORY PIE -------- */
      new Chart(document.getElementById('categoryPie'), {
        type: 'doughnut',
        data: {
          labels: [{% for c in category_distribution %}'{{ c.category__name }}',{% endfor %}],
          datasets: [{
            data: [{% for c in category_distribution %}{{ c.quiz_count }},{% endfor %}],
            backgroundColor: ['#6366f1', '#22c55e', '#f97316', '#06b6d4', '#ec4899', '#8b5cf6'],
            borderWidth: 0
          }]
        },
        options: {
          plugins: {
            legend: {
              position: 'bottom',
              labels: {
                padding: 20,
                usePointStyle: true
              }
            }
          },
          cutout: '65%'
        }
      });

      /* -------- SUBCATEGORY BAR -------- */
      new Chart(document.getElementById('subcategoryBar'), {
        type: 'bar',
        data: {
          labels: [{% for s in subcategory_accuracy %}'{{ s.subcategory }}',{% endfor %}],
          datasets: [{
            label: 'Accuracy (%)',
            data: [{% for s in subcategory_accuracy %}{{ s.accuracy }},{% endfor %}],
            backgroundColor: 'rgba(34, 197, 94, 0.5)',
            borderColor: '#22c55e',
            borderWidth: 1,
            borderRadius: 6
          }]
        },
        options: {
          scales: {
            y: { 
              beginAtZero: true, 
              max: 100,
              grid: {
                color: 'rgba(255, 255, 255, 0.05)'
              }
            },
            x: {
              grid: {
                display: false
              }
            }
          },
          plugins: {
            legend: {
              display: false
            }
          }
        }
      });

      /* -------- DIFFICULTY BAR -------- */
      new Chart(document.getElementById('difficultyBar'), {
        type: 'bar',
        data: {
          labels: [{% for d in difficulty_performance %}'{{ d.difficulty }}',{% endfor %}],
          datasets: [{
            label: 'Average Score (%)',
            data: [{% for d in difficulty_performance %}{{ d.avg_score|floatformat:2 }},{% endfor %}],
            backgroundColor: ['rgba(34, 197, 94, 0.5)', 'rgba(250, 204, 21, 0.5)', 'rgba(239, 68, 68, 0.5)'],
            borderColor: ['#22c55e', '#facc15', '#ef4444'],
            borderWidth: 1,
            borderRadius: 6
          }]
        },
        options: {
          scales: {
            y: { 
              beginAtZero: true, 
              max: 100,
              grid: {
                color: 'rgba(255, 255, 255, 0.05)'
              }
            },
            x: {
              grid: {
                display: false
              }
            }
          },
          plugins: {
            legend: {
              display: false
            }
          }
        }
      });

      /* -------- PERFORMANCE OVER TIME -------- */
      new Chart(document.getElementById('timeLine'), {
        type: 'line',
        data: {
          labels: [{% for p in performance_over_time %}'{{ p.date }}',{% endfor %}],
          datasets: [{
            label: 'Avg Score (%)',
            data: [{% for p in performance_over_time %}{{ p.avg_score|floatformat:2 }},{% endfor %}],
            borderColor: '#8b5cf6',
            backgroundColor: 'rgba(139, 92, 246, 0.1)',
            tension: 0.4,
            fill: true,
            pointBackgroundColor: '#8b5cf6',
            pointBorderColor: '#fff',
            pointBorderWidth: 2,
            pointRadius: 4
          }]
        },
        options: {
          scales: {
            y: { 
              beginAtZero: true,
              grid: {
                color: 'rgba(255, 255, 255, 0.05)'
              }
            },
            x: {
              grid: {
                display: false
              }
            }
          },
          plugins: {
            legend: {
              display: false
            }
          }
        }
      });
    </script>
  </body>
</html>
