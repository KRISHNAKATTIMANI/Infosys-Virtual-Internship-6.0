{% load static %}
<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Select Your Quiz | AI Quiz Hub</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap"
        rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/remixicon/fonts/remixicon.css" rel="stylesheet">
    <link rel="stylesheet" href="{% static 'quizzes/css/quiz_selector.css' %}">
    
    <!-- Theme System -->
    <link rel="stylesheet" href="{% static 'css/theme.css' %}" />
    <script src="{% static 'js/theme.js' %}"></script>
</head>

<body>
    <!-- Navbar -->
    <div class="navbar">
        <div class="brand">AI Quiz Hub</div>
        <div class="nav-links">
            <a href="{% url 'quizzes:dashboard' %}">Dashboard</a>
            <a href="{% url 'quizzes:ai_quiz_generator' %}">AI Generator</a>
            <a href="{% url 'accounts:profile' %}">Profile</a>
            <a href="{% url 'accounts:logout' %}">Logout</a>
            <button class="theme-toggle-btn" id="themeToggle" title="Toggle Theme">
                <i class="ri-moon-line"></i>
            </button>
        </div>
    </div>

    <div class="spa-container">
        <!-- Header -->
        <div class="spa-header">
            <div class="spa-header-content">
                <span style="font-size: 2rem;">üéØ</span>
                <div>
                    <h1>Choose Your Quiz</h1>
                    <p>Select a quiz mode and generation method</p>
                </div>
            </div>
        </div>

        <!-- Step 1: Quiz Mode Selection -->
        <div class="quiz-type-section" id="quiz-mode-section" style="background:white;border-radius:16px;padding:24px;margin-bottom:20px;box-shadow:0 4px 15px rgba(0,0,0,0.05);">
            <h3 class="quiz-type-title" style="font-size:16px;font-weight:600;color:#4f46e5;margin-bottom:16px;">üìã Step 1: Select Quiz Mode</h3>
            <div class="quiz-type-options" style="display:grid;grid-template-columns:repeat(2,1fr);gap:16px;">
                <div class="quiz-mode-card" data-mode="personal" id="quiz-mode-personal" style="display:flex;align-items:center;gap:16px;padding:20px 24px;background:#f8fafc;border:2px solid #e2e8f0;border-radius:12px;cursor:pointer;transition:all 0.3s ease;">
                    <div class="quiz-type-icon" style="font-size:2.5rem;flex-shrink:0;">üß†</div>
                    <div class="quiz-type-content" style="flex:1;">
                        <h4 style="font-size:16px;font-weight:600;color:#1e293b;margin:0 0 4px 0;">Personal Quiz</h4>
                        <p style="font-size:13px;color:#64748b;margin:0;">Test and improve your own skills</p>
                    </div>
                    <div class="quiz-type-check" style="font-size:24px;color:#4f46e5;opacity:0;"><i class="ri-checkbox-circle-fill"></i></div>
                </div>
                <div class="quiz-mode-card" data-mode="classroom" id="quiz-mode-classroom" style="display:flex;align-items:center;gap:16px;padding:20px 24px;background:#f8fafc;border:2px solid #e2e8f0;border-radius:12px;cursor:pointer;transition:all 0.3s ease;">
                    <div class="quiz-type-icon" style="font-size:2.5rem;flex-shrink:0;">üë•</div>
                    <div class="quiz-type-content" style="flex:1;">
                        <h4 style="font-size:16px;font-weight:600;color:#1e293b;margin:0 0 4px 0;">Classroom Quiz</h4>
                        <p style="font-size:13px;color:#64748b;margin:0;">Create quiz for multiple participants</p>
                    </div>
                    <div class="quiz-type-check" style="font-size:24px;color:#4f46e5;opacity:0;"><i class="ri-checkbox-circle-fill"></i></div>
                </div>
            </div>
        </div>

        <!-- Step 2: Generation Method (Hidden by default) -->
        <div class="quiz-type-section" id="generation-method-section" style="background:white;border-radius:16px;padding:24px;margin-bottom:20px;box-shadow:0 4px 15px rgba(0,0,0,0.05);display:none;">
            <h3 class="quiz-type-title" style="font-size:16px;font-weight:600;color:#10b981;margin-bottom:16px;">üìù Step 2: Choose How to Generate Quiz</h3>
            <div class="quiz-type-options" style="display:grid;grid-template-columns:repeat(2,1fr);gap:16px;">
                <div class="generation-method-card" data-method="document" id="method-document" style="display:flex;align-items:center;gap:16px;padding:20px 24px;background:#f8fafc;border:2px solid #e2e8f0;border-radius:12px;cursor:pointer;transition:all 0.3s ease;">
                    <div class="quiz-type-icon" style="font-size:2.5rem;flex-shrink:0;">üìÑ</div>
                    <div class="quiz-type-content" style="flex:1;">
                        <h4 style="font-size:16px;font-weight:600;color:#1e293b;margin:0 0 4px 0;">Upload Document</h4>
                        <p style="font-size:13px;color:#64748b;margin:0;">Generate quiz from PDF, DOCX, or TXT files</p>
                    </div>
                    <div class="quiz-type-check" style="font-size:24px;color:#f59e0b;"><i class="ri-upload-cloud-2-line"></i></div>
                </div>
                <div class="generation-method-card" data-method="categories" id="method-categories" style="display:flex;align-items:center;gap:16px;padding:20px 24px;background:#f8fafc;border:2px solid #e2e8f0;border-radius:12px;cursor:pointer;transition:all 0.3s ease;">
                    <div class="quiz-type-icon" style="font-size:2.5rem;flex-shrink:0;">üìö</div>
                    <div class="quiz-type-content" style="flex:1;">
                        <h4 style="font-size:16px;font-weight:600;color:#1e293b;margin:0 0 4px 0;">Select from Categories</h4>
                        <p style="font-size:13px;color:#64748b;margin:0;">Choose from predefined topics and subjects</p>
                    </div>
                    <div class="quiz-type-check" style="font-size:24px;color:#10b981;opacity:0;"><i class="ri-checkbox-circle-fill"></i></div>
                </div>
            </div>
        </div>

        <!-- Categories Section (Hidden by default) -->
        <div id="categories-section" style="display:none;">
            <!-- Breadcrumb Trail -->
            <div class="breadcrumb" id="breadcrumb">
                <span class="breadcrumb-item active">Select a Category</span>
            </div>

            <!-- Two Column Layout -->
            <div class="content-wrapper">
                <!-- Left: Levels -->
                <div class="levels-section" id="levels-container">
                    <!-- Level 1: Categories -->
                    <div class="level-container" data-level="1">
                        <div class="level-label"><span>1</span> Categories</div>
                        <div class="cards-grid">
                            {% for cat in categories %}
                            <div class="selection-card" data-type="category" data-id="{{ cat.id }}"
                                data-name="{{ cat.name }}">
                                <span class="card-icon">
                                    {% if 'Academic' in cat.name %}üìö
                                    {% elif 'Entertainment' in cat.name %}üé¨
                                    {% elif 'General' in cat.name %}üåç
                                    {% else %}üìÅ{% endif %}
                                </span>
                                <div class="card-content">
                                    <div class="card-name">{{ cat.name }}</div>
                                    <div class="card-desc">{{ cat.description|default:"Explore topics" }}</div>
                                </div>
                            </div>
                            {% empty %}
                            <div class="empty-state">
                                <div class="empty-state-icon">üì≠</div>
                                <p>No categories available.</p>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                </div>

                <!-- Right: Sidebar -->
                <div class="sidebar-section">
                    <!-- Placeholder when nothing selected -->
                    <div class="sidebar-placeholder" id="sidebar-placeholder">
                        <div class="sidebar-placeholder-icon">üìã</div>
                        <h4>Your Selection</h4>
                        <p>Select categories to see options here</p>
                    </div>

                <!-- Selection Summary (shown when selecting) -->
                <div class="difficulty-panel" id="sidebar-content" style="display: none;">
                    <div class="selection-summary">
                        <h4>Selected Path</h4>
                        <div class="selection-path" id="selection-path"></div>
                    </div>

                    <h3>‚ö° Difficulty Level</h3>
                    <div class="difficulty-options">
                        <button class="difficulty-btn easy" data-difficulty="easy">Easy</button>
                        <button class="difficulty-btn medium" data-difficulty="medium">Medium</button>
                        <button class="difficulty-btn hard" data-difficulty="hard">Hard</button>
                    </div>

                    <!-- Start Quiz Button -->
                    <div class="start-quiz-container" id="start-container" style="display: none;">
                        <a href="#" class="start-quiz-btn" id="start-quiz-btn">
                            üöÄ Start Quiz
                        </a>
                    </div>
                </div>
            </div>
        </div>
        </div>
    </div>

    <script>
        (function () {
            // State management
            const state = {
                selections: [],
                leafSubcategoryId: null,
                quizMode: null, // 'personal' or 'classroom'
                generationMethod: null, // 'document' or 'categories'
                difficulty: null
            };

            const levelsContainer = document.getElementById('levels-container');
            const breadcrumb = document.getElementById('breadcrumb');
            const sidebarPlaceholder = document.getElementById('sidebar-placeholder');
            const sidebarContent = document.getElementById('sidebar-content');
            const selectionPath = document.getElementById('selection-path');
            const startContainer = document.getElementById('start-container');
            const startBtn = document.getElementById('start-quiz-btn');
            
            // New sections
            const quizModeSection = document.getElementById('quiz-mode-section');
            const generationMethodSection = document.getElementById('generation-method-section');
            const categoriesSection = document.getElementById('categories-section');

            // CSRF token for AJAX
            function getCsrfToken() {
                const cookie = document.cookie.split(';').find(c => c.trim().startsWith('csrftoken='));
                return cookie ? cookie.split('=')[1] : '';
            }

            // Step 1: Quiz Mode Selection
            const quizModeCards = document.querySelectorAll('.quiz-mode-card');
            quizModeCards.forEach(card => {
                card.addEventListener('click', () => {
                    // Update visual selection
                    quizModeCards.forEach(c => {
                        c.classList.remove('selected');
                        c.style.background = '#f8fafc';
                        c.style.border = '2px solid #e2e8f0';
                        c.querySelector('.quiz-type-check').style.opacity = '0';
                    });
                    card.classList.add('selected');
                    card.style.background = 'linear-gradient(135deg,#eef2ff,#e0e7ff)';
                    card.style.border = '2px solid #4f46e5';
                    card.querySelector('.quiz-type-check').style.opacity = '1';
                    
                    state.quizMode = card.dataset.mode;
                    
                    // Show Step 2: Generation Method
                    generationMethodSection.style.display = 'block';
                    
                    // Reset Step 2 and categories
                    state.generationMethod = null;
                    categoriesSection.style.display = 'none';
                    
                    // Reset generation method card visuals
                    document.querySelectorAll('.generation-method-card').forEach(c => {
                        c.classList.remove('selected');
                        c.style.background = '#f8fafc';
                        c.style.border = '2px solid #e2e8f0';
                        const check = c.querySelector('.quiz-type-check');
                        if (c.dataset.method === 'document') {
                            check.innerHTML = '<i class="ri-upload-cloud-2-line"></i>';
                            check.style.color = '#f59e0b';
                            check.style.opacity = '1';
                        } else {
                            check.innerHTML = '<i class="ri-checkbox-circle-fill"></i>';
                            check.style.color = '#10b981';
                            check.style.opacity = '0';
                        }
                    });
                    
                    // Show classroom coming soon message
                    const existingBanner = document.querySelector('.coming-soon-banner');
                    if (existingBanner) existingBanner.remove();
                    
                    if (state.quizMode === 'classroom') {
                        const banner = document.createElement('div');
                        banner.className = 'coming-soon-banner';
                        banner.innerHTML = `
                            <i class="ri-information-line"></i>
                            <span>Classroom quiz mode is coming soon! For now, you can create quizzes with the same features.</span>
                            <button onclick="this.parentElement.remove()" style="background:none;border:none;color:inherit;cursor:pointer;font-size:18px;margin-left:auto;"><i class="ri-close-line"></i></button>
                        `;
                        banner.style.cssText = 'display:flex;align-items:center;gap:12px;background:linear-gradient(135deg,#f59e0b,#fbbf24);color:#0f172a;padding:12px 20px;border-radius:10px;margin-bottom:16px;font-weight:500;font-size:14px;';
                        generationMethodSection.after(banner);
                    }
                    
                    // Scroll to Step 2
                    generationMethodSection.scrollIntoView({ behavior: 'smooth', block: 'center' });
                });
            });

            // Step 2: Generation Method Selection
            const generationMethodCards = document.querySelectorAll('.generation-method-card');
            generationMethodCards.forEach(card => {
                card.addEventListener('click', () => {
                    const method = card.dataset.method;
                    state.generationMethod = method;
                    
                    // Update visual selection
                    generationMethodCards.forEach(c => {
                        c.classList.remove('selected');
                        c.style.background = '#f8fafc';
                        c.style.border = '2px solid #e2e8f0';
                        const check = c.querySelector('.quiz-type-check');
                        if (c.dataset.method === 'document') {
                            check.innerHTML = '<i class="ri-upload-cloud-2-line"></i>';
                            check.style.color = '#f59e0b';
                        } else {
                            check.innerHTML = '<i class="ri-checkbox-circle-fill"></i>';
                            check.style.color = '#10b981';
                            check.style.opacity = '0';
                        }
                    });
                    
                    card.classList.add('selected');
                    if (method === 'document') {
                        card.style.background = 'linear-gradient(135deg,#fef3c7,#fde68a)';
                        card.style.border = '2px solid #f59e0b';
                        // Redirect to document upload page
                        window.location.href = "{% url 'quizzes:ai_quiz_generator' %}";
                    } else {
                        card.style.background = 'linear-gradient(135deg,#ecfdf5,#d1fae5)';
                        card.style.border = '2px solid #10b981';
                        card.querySelector('.quiz-type-check').style.opacity = '1';
                        // Show categories section
                        categoriesSection.style.display = 'block';
                        categoriesSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
                    }
                });
            });

            // Update breadcrumb display
            function updateBreadcrumb() {
                let html = '';
                if (state.selections.length === 0) {
                    html = '<span class="breadcrumb-item active">Select a Category</span>';
                } else {
                    state.selections.forEach((sel, i) => {
                        const isLast = i === state.selections.length - 1;
                        html += `<span class="breadcrumb-item ${isLast ? 'active' : ''}">${sel.name}</span>`;
                        if (!isLast) {
                            html += '<span class="breadcrumb-separator">‚Ä∫</span>';
                        }
                    });
                }
                breadcrumb.innerHTML = html;
            }

            // Update sidebar selection path
            function updateSelectionPath() {
                let html = '';
                state.selections.forEach(sel => {
                    html += `<span class="path-item">${sel.name}</span>`;
                });
                selectionPath.innerHTML = html;
            }

            // Clear levels after a given level number
            function clearLevelsAfter(level) {
                const containers = levelsContainer.querySelectorAll('.level-container');
                containers.forEach(c => {
                    if (parseInt(c.dataset.level) > level) {
                        c.remove();
                    }
                });
                state.selections = state.selections.filter(s => s.level <= level);
                state.leafSubcategoryId = null;
                state.difficulty = null;
                startContainer.style.display = 'none';
                document.querySelectorAll('.difficulty-btn').forEach(btn => btn.classList.remove('selected'));
            }

            // Render a new level of cards
            function renderLevel(level, children, parentName) {
                const levelDiv = document.createElement('div');
                levelDiv.className = 'level-container';
                levelDiv.dataset.level = level;

                let levelLabel = 'Options';
                if (level === 2) levelLabel = 'Sub-categories';
                else if (level === 3) levelLabel = 'Streams';
                else if (level >= 4) levelLabel = 'Topics';

                let cardsHtml = '';
                if (children.length === 0) {
                    cardsHtml = `
                    <div class="empty-state">
                        <div class="empty-state-icon">üì≠</div>
                        <p>No sub-topics for ${parentName}</p>
                    </div>
                `;
                } else {
                    children.forEach(child => {
                        const icon = child.is_leaf ? 'üìù' : 'üìÇ';
                        cardsHtml += `
                        <div class="selection-card" 
                             data-type="subcategory" 
                             data-id="${child.id}" 
                             data-name="${child.name}"
                             data-is-leaf="${child.is_leaf}">
                            <span class="card-icon">${icon}</span>
                            <div class="card-content">
                                <div class="card-name">${child.name}</div>
                                <div class="card-desc">${child.description || 'Click to explore'}</div>
                            </div>
                        </div>
                    `;
                    });
                }

                levelDiv.innerHTML = `
                <div class="level-label"><span>${level}</span> ${levelLabel}</div>
                <div class="cards-grid">${cardsHtml}</div>
            `;

                levelsContainer.appendChild(levelDiv);
                attachCardListeners(levelDiv);
            }

            // Fetch children from server
            async function fetchChildren(nodeType, nodeId) {
                const url = `{% url 'quizzes:get_children' %}?node_type=${nodeType}&node_id=${nodeId}`;
                try {
                    const response = await fetch(url, {
                        headers: { 'X-CSRFToken': getCsrfToken() }
                    });
                    if (!response.ok) throw new Error('Network error');
                    return await response.json();
                } catch (error) {
                    console.error('Error fetching children:', error);
                    return { children: [], parent_name: '' };
                }
            }

            // Handle card click
            async function handleCardClick(card) {
                const type = card.dataset.type;
                const id = card.dataset.id;
                const name = card.dataset.name;
                const isLeaf = card.dataset.isLeaf === 'true';
                const levelContainer = card.closest('.level-container');
                const level = parseInt(levelContainer.dataset.level);

                clearLevelsAfter(level);

                state.selections = state.selections.filter(s => s.level < level);
                state.selections.push({ type, id, name, level });

                levelContainer.querySelectorAll('.selection-card').forEach(c => c.classList.remove('selected'));
                card.classList.add('selected');

                updateBreadcrumb();
                updateSelectionPath();

                if (isLeaf) {
                    // Set the leaf subcategory ID as integer
                    state.leafSubcategoryId = parseInt(id, 10);
                    sidebarPlaceholder.style.display = 'none';
                    sidebarContent.style.display = 'block';
                } else {
                    // Not a leaf - hide sidebar and reset leaf ID
                    state.leafSubcategoryId = null;
                    state.difficulty = null;
                    sidebarPlaceholder.style.display = 'block';
                    sidebarContent.style.display = 'none';
                    startContainer.style.display = 'none';
                    document.querySelectorAll('.difficulty-btn').forEach(b => b.classList.remove('selected'));

                    const data = await fetchChildren(type, id);
                    if (data.children && data.children.length >= 0) {
                        renderLevel(level + 1, data.children, name);
                    }
                }
            }

            // Attach listeners to cards
            function attachCardListeners(container) {
                container.querySelectorAll('.selection-card').forEach(card => {
                    card.addEventListener('click', () => handleCardClick(card));
                });
            }

            // Difficulty button clicks
            document.querySelectorAll('.difficulty-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    document.querySelectorAll('.difficulty-btn').forEach(b => b.classList.remove('selected'));
                    btn.classList.add('selected');
                    state.difficulty = btn.dataset.difficulty;

                    startContainer.style.display = 'block';
                    startBtn.href = `{% url 'quizzes:instructions' 0 'easy' %}`.replace('/0/', `/${state.leafSubcategoryId}/`).replace('/easy/', `/${state.difficulty}/`);
                });
            });

            // Initialize
            attachCardListeners(document.querySelector('.level-container'));
        })();
    </script>
</body>

</html>