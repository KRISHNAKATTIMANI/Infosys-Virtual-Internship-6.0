{% load static %}
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, viewport-fit=cover"
    />
    <title>Dashboard â€” AI Quiz Hub</title>

    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&family=Press+Start+2P&display=swap"
      rel="stylesheet"
    />
    <link
      href="https://cdn.jsdelivr.net/npm/remixicon/fonts/remixicon.css"
      rel="stylesheet"
    />
    {% load static %}
    <link
      rel="stylesheet"
      href="{% static 'quizzes/css/dashboard.css' %}?v=7"
    />

    <!-- Theme System -->
    <link rel="stylesheet" href="{% static 'css/theme.css' %}" />
    <script src="{% static 'js/theme.js' %}"></script>

    <style>
      /* Light Mode Overrides for Dashboard */
      body.light-mode {
        background: #0f172a;
      }

      body.light-mode .sidebar {
        background: #1e293b;
        border-right-color: rgba(255, 255, 255, 0.1);
      }

      body.light-mode .sidebar-brand span,
      body.light-mode .nav-item span {
        color: #f8fafc;
      }

      body.light-mode .nav-item {
        color: #cbd5e1;
      }

      body.light-mode .nav-item:hover,
      body.light-mode .nav-item.active {
        background: rgba(99, 102, 241, 0.2);
        color: #a5b4fc;
      }

      body.light-mode .main-content {
        background: #0f172a;
      }

      body.light-mode .topbar {
        background: rgba(30, 41, 59, 0.95);
        border-bottom-color: rgba(255, 255, 255, 0.1);
      }

      body.light-mode .page-title h1 {
        color: #f8fafc;
      }

      body.light-mode .page-title p {
        color: #94a3b8;
      }

      body.light-mode .stat-card,
      body.light-mode .action-card,
      body.light-mode .recent-card,
      body.light-mode .bento-card {
        background: rgba(30, 41, 59, 0.8) !important;
        border: 1px solid rgba(255, 255, 255, 0.1) !important;
      }

      body.light-mode .stat-card:hover,
      body.light-mode .action-card:hover,
      body.light-mode .bento-card:hover {
        background: rgba(30, 41, 59, 0.9) !important;
        border-color: rgba(99, 102, 241, 0.5) !important;
      }
      
      body.light-mode .bento-card.bento-large {
        background: rgba(30, 41, 59, 0.8) !important;
        border: 1px solid rgba(255, 255, 255, 0.1) !important;
      }
      
      body.light-mode .bento-card.bento-large:hover {
        background: rgba(30, 41, 59, 0.9) !important;
        border-color: rgba(99, 102, 241, 0.5) !important;
      }

      body.light-mode .stat-value,
      body.light-mode .action-title {
        color: #f8fafc;
      }

      body.light-mode .stat-label,
      body.light-mode .action-description {
        color: #94a3b8;
      }

      body.light-mode .user-name {
        color: #f8fafc;
      }

      body.light-mode .user-role {
        color: #94a3b8;
      }
      
      /* Bento Card Text Colors for Dark Mode */
      body.light-mode .bento-card h2,
      body.light-mode .bento-card h3 {
        color: #f8fafc !important;
        -webkit-text-fill-color: #f8fafc !important;
      }
      
      body.light-mode .analytics-card h3,
      body.light-mode .attempts-card h3,
      body.light-mode .leaderboard-card h3,
      body.light-mode .recent-card h3,
      body.light-mode .start-quiz-card h2 {
        color: #f8fafc !important;
        -webkit-text-fill-color: #f8fafc !important;
        background: none !important;
      }
      
      body.light-mode .bento-card p {
        color: #cbd5e1 !important;
      }
      
      body.light-mode .bento-action,
      body.light-mode .bento-action span {
        color: #fbbf24 !important;
      }
      
      body.light-mode .start-quiz-card .bento-action span {
        color: #fbbf24 !important;
        -webkit-text-fill-color: #fbbf24 !important;
      }

      /* Topbar User Profile - Dark Mode */
      body.light-mode .topbar-right .user-profile {
        background: rgba(30, 41, 59, 0.8) !important;
        border: 1px solid rgba(255, 255, 255, 0.1) !important;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.3) !important;
      }
      
      body.light-mode .topbar-right .user-profile:hover {
        background: rgba(30, 41, 59, 0.9) !important;
        border-color: rgba(99, 102, 241, 0.4) !important;
        box-shadow: 0 4px 15px rgba(99, 102, 241, 0.25) !important;
      }
      
      body.light-mode .topbar-right .user-name {
        color: #f8fafc !important;
      }
      
      body.light-mode .topbar-right .user-role {
        color: #94a3b8 !important;
      }
      
      body.light-mode .topbar-right .user-avatar-placeholder {
        background: linear-gradient(135deg, #f59e0b, #fbbf24) !important;
        color: #1e293b !important;
      }

      /* Theme Toggle Button Styles */
      .topbar-right .theme-toggle-btn {
        position: relative;
        z-index: 100;
        width: 44px;
        height: 44px;
        border-radius: 50%;
        background: rgba(99, 102, 241, 0.1);
        backdrop-filter: blur(10px);
        border: 1px solid rgba(99, 102, 241, 0.2);
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 20px;
        color: #6366f1;
        transition: all 0.3s ease;
        box-shadow: 0 2px 10px rgba(99, 102, 241, 0.15);
        flex-shrink: 0;
      }

      .topbar-right .theme-toggle-btn:hover {
        transform: scale(1.1);
        background: rgba(99, 102, 241, 0.2);
        box-shadow: 0 4px 15px rgba(99, 102, 241, 0.25);
      }

      body.light-mode .topbar-right .theme-toggle-btn {
        background: rgba(251, 191, 36, 0.15);
        border-color: rgba(251, 191, 36, 0.3);
        color: #fbbf24;
        box-shadow: 0 2px 10px rgba(251, 191, 36, 0.2);
      }

      body.light-mode .topbar-right .theme-toggle-btn:hover {
        background: rgba(251, 191, 36, 0.25);
        box-shadow: 0 4px 15px rgba(251, 191, 36, 0.3);
      }
    </style>
  </head>

  <body style="width: 100%; overflow-x: hidden">
    <!-- SIDEBAR -->
    <aside class="sidebar" id="sidebar">
      <div class="sidebar-brand">
        <div class="brand-icon">
          <i class="ri-brain-line"></i>
        </div>
        <span>AI Quiz Hub</span>
      </div>

      <!-- Sidebar Toggle Button -->
      <button
        class="sidebar-toggle-btn"
        id="sidebarToggle"
        title="Toggle Sidebar"
      >
        <i class="ri-arrow-left-s-line"></i>
      </button>

      <nav class="sidebar-nav">
        <a href="{% url 'accounts:profile' %}" class="nav-item">
          <i class="ri-user-line"></i>
          <span>Profile</span>
        </a>
        <a href="{% url 'quizzes:dashboard' %}" class="nav-item active">
          <i class="ri-dashboard-3-line"></i>
          <span>Dashboard</span>
        </a>
        <a href="{% url 'quizzes:attempts_summary' %}" class="nav-item">
          <i class="ri-timer-line"></i>
          <span>Attempts Summary</span>
        </a>
        <a href="{% url 'quizzes:recent_quizzes' %}" class="nav-item">
          <i class="ri-history-line"></i>
          <span>Recent quizzes</span>
        </a>
      </nav>

      <div class="sidebar-footer">
        <a href="{% url 'accounts:logout' %}" class="logout-btn">
          <i class="ri-logout-box-r-line"></i>
          <span>Logout</span>
        </a>
      </div>
    </aside>

    <!-- MAIN CONTENT -->
    <main class="main-content">
      <!-- TOP BAR -->
      <header class="topbar">
        <div class="topbar-left">
          <div class="page-title">
            <h1>Dashboard</h1>
            <p>Welcome back, let's continue learning!</p>
          </div>
        </div>
        <div class="topbar-right">
          <!-- Theme Toggle Button -->
          <button
            class="theme-toggle-btn"
            id="themeToggle"
            title="Toggle Theme"
          >
            <i class="ri-moon-line"></i>
          </button>

          <a
            href="{% url 'accounts:profile' %}"
            class="user-profile"
            title="View Profile"
          >
            {% if request.user.avatar_path %}
            <img
              src="{{ request.user.avatar_path.url }}"
              class="user-avatar"
              alt="Avatar"
            />
            {% else %}
            <div class="user-avatar-placeholder">
              {{request.user.username|default:request.user.username|slice:":1"|upper}}
            </div>
            {% endif %}
            <div class="user-info">
              <span class="user-name">{{ request.user.full_name|default:request.user.username}}</span>
              <span class="user-role">Learner</span>
            </div>
          </a>
          <form
            action="{% url 'accounts:logout' %}"
            method="post"
            class="topbar-logout-form"
          >
            {% csrf_token %}
            <button type="submit" class="topbar-logout-btn" title="Logout">
              <i class="ri-logout-box-r-line"></i>
            </button>
          </form>
        </div>
      </header>

      <!-- DASHBOARD GRID -->
      <div class="dashboard-grid">
        <!-- STATS ROW -->
        <div class="stats-grid">
          <div class="stat-card">
            <div class="stat-header">
              <div class="stat-icon blue">
                <i class="ri-file-list-3-line"></i>
              </div>
            </div>
            <div class="stat-value">{{ total_completed }}</div>
            <div class="stat-label">Quizzes Completed</div>
          </div>

          <div class="stat-card">
            <div class="stat-header">
              <div class="stat-icon gold">
                <i class="ri-percent-line"></i>
              </div>
            </div>
            <div class="stat-value">{{ avg_score }}%</div>
            <div class="stat-label">Average Score</div>
          </div>

          <div class="stat-card">
            <div class="stat-header">
              <div class="stat-icon green">
                <i class="ri-star-line"></i>
              </div>
            </div>
            <div class="stat-value">{{ best_score }}%</div>
            <div class="stat-label">Best Score</div>
          </div>

          <div class="stat-card">
            <div class="stat-header">
              <div class="stat-icon purple">
                <i class="ri-checkbox-circle-line"></i>
              </div>
            </div>
            <div class="stat-value">{{ completion_rate }}%</div>
            <div class="stat-label">Completion Rate</div>
          </div>
        </div>

        <!-- MAIN BENTO GRID -->
        <div class="bento-grid">
          <!-- START QUIZ - Large Card -->
          <a
            href="{% url 'quizzes:pre_start_quiz' %}"
            class="bento-card bento-large start-quiz-card"
          >
            <div class="bento-bg-pattern"></div>
            <div class="bento-content">
              <div class="bento-icon-large">
                <i class="ri-rocket-2-line"></i>
              </div>
              <h2>Start New Quiz</h2>
              <p>
                Challenge yourself with AI-powered questions tailored to your
                skill level
              </p>
              <div class="bento-action">
                <span>Begin Now</span>
                <i class="ri-arrow-right-line"></i>
              </div>
            </div>
          </a>

          <!-- PERFORMANCE ANALYTICS -->
          <a
            href="{% url 'quizzes:performance_dashboard' %}"
            class="bento-card analytics-card"
          >
            <div class="bento-header">
              <div class="bento-icon">
                <i class="ri-bar-chart-grouped-line"></i>
              </div>
              <i class="ri-arrow-right-up-line bento-arrow"></i>
            </div>
            <h3>Performance Analytics</h3>
            <p>Track your progress with detailed insights</p>
          </a>

          <!-- LEADERBOARD -->
          <a
            href="{% url 'quizzes:leaderboard' %}"
            class="bento-card leaderboard-card"
          >
            <div class="bento-header">
              <div class="bento-icon">
                <i class="ri-trophy-line"></i>
              </div>
              <i class="ri-arrow-right-up-line bento-arrow"></i>
            </div>
            <h3>Leaderboard</h3>
            <p>Compete with top performers</p>
            <div class="leaderboard-preview">
              <div class="rank-badge rank-1">ðŸ¥‡</div>
              <div class="rank-badge rank-2">ðŸ¥ˆ</div>
              <div class="rank-badge rank-3">ðŸ¥‰</div>
            </div>
          </a>
        </div>

        <!-- PERFORMANCE CHARTS SECTION -->
        <div class="charts-section">
          <div class="section-header">
            <div class="section-header-left">
              <h2>
                <i class="ri-line-chart-line"></i> Your Activity (Past 30 Days)
              </h2>
              <p>Track your learning progress and quiz performance</p>
            </div>
            <button
              class="refresh-charts-btn"
              id="refreshChartsBtn"
              title="Refresh Charts"
            >
              <i class="ri-refresh-line"></i>
              <span>Refresh</span>
            </button>
          </div>

          <div class="charts-grid">
            <!-- Category Distribution -->
            <div class="chart-card chart-small">
              <div class="chart-header">
                <h3><i class="ri-pie-chart-2-line"></i> Categories</h3>
                <span class="chart-period">Quiz distribution</span>
              </div>
              <div class="chart-container chart-container-small">
                <canvas id="categoryChart"></canvas>
              </div>
            </div>

            <!-- Difficulty Distribution -->
            <div class="chart-card chart-small">
              <div class="chart-header">
                <h3><i class="ri-equalizer-line"></i> Difficulty</h3>
                <span class="chart-period">By difficulty level</span>
              </div>
              <div class="chart-container chart-container-small">
                <canvas id="difficultyChart"></canvas>
              </div>
            </div>

            <!-- Score Trend Chart -->
            <div class="chart-card">
              <div class="chart-header">
                <h3><i class="ri-line-chart-line"></i> Score Trend</h3>
                <span class="chart-period">Average daily scores</span>
              </div>
              <div class="chart-container">
                <canvas id="scoreChart"></canvas>
              </div>
            </div>

            <!-- Quiz Activity Chart -->
            <div class="chart-card">
              <div class="chart-header">
                <h3><i class="ri-bar-chart-2-line"></i> Quiz Activity</h3>
                <span class="chart-period">Daily quizzes completed</span>
              </div>
              <div class="chart-container">
                <canvas id="activityChart"></canvas>
              </div>
            </div>
          </div>
        </div>
      </div>
    </main>

    <!-- Chart.js Library -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <script>
      // Chart Data from Django
      const chartLabels = {{ chart_labels|safe }};
      const chartQuizCounts = {{ chart_quiz_counts|safe }};
      const chartScores = {{ chart_scores|safe }};
      const categoryLabels = {{ category_labels|safe }};
      const categoryCounts = {{ category_counts|safe }};
      const difficultyLabels = {{ difficulty_labels|safe }};
      const difficultyCounts = {{ difficulty_counts|safe }};
      const difficultyScores = {{ difficulty_scores|safe }};

      // Get theme for chart colors
      // Note: 'light-mode' class = DARK theme (dark backgrounds, light text)
      // No 'light-mode' class = LIGHT theme (light backgrounds, dark text)
      const getChartColors = () => {
        const isDarkTheme = document.body.classList.contains('light-mode');
        return {
          // Dark theme = light text, Light theme = dark text
          text: isDarkTheme ? '#cbd5e1' : '#334155',
          grid: isDarkTheme ? 'rgba(203, 213, 225, 0.15)' : 'rgba(51, 65, 85, 0.15)',
          primary: '#6366f1',
          secondary: '#10b981',
          accent: '#f59e0b',
        };
      };

      // Quiz Activity Bar Chart
      const activityCtx = document.getElementById('activityChart').getContext('2d');
      const activityChart = new Chart(activityCtx, {
        type: 'bar',
        data: {
          labels: chartLabels,
          datasets: [{
            label: 'Quizzes Completed',
            data: chartQuizCounts,
            backgroundColor: 'rgba(99, 102, 241, 0.7)',
            borderColor: 'rgba(99, 102, 241, 1)',
            borderWidth: 1,
            borderRadius: 4,
            barThickness: 8,
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { display: false },
            tooltip: {
              backgroundColor: 'rgba(30, 41, 59, 0.95)',
              titleColor: '#fff',
              bodyColor: '#fff',
              padding: 12,
              cornerRadius: 8,
            }
          },
          scales: {
            x: {
              grid: { display: false },
              ticks: {
                color: getChartColors().text,
                maxRotation: 45,
                minRotation: 45,
                font: { size: 10 }
              }
            },
            y: {
              beginAtZero: true,
              grid: { color: getChartColors().grid },
              ticks: {
                color: getChartColors().text,
                stepSize: 1
              }
            }
          }
        }
      });

      // Score Trend Line Chart
      const scoreCtx = document.getElementById('scoreChart').getContext('2d');
      const scoreChart = new Chart(scoreCtx, {
        type: 'line',
        data: {
          labels: chartLabels,
          datasets: [{
            label: 'Average Score (%)',
            data: chartScores,
            borderColor: '#10b981',
            backgroundColor: 'rgba(16, 185, 129, 0.1)',
            borderWidth: 2,
            fill: true,
            tension: 0.4,
            pointRadius: 0,
            pointHoverRadius: 6,
            pointHoverBackgroundColor: '#10b981',
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { display: false },
            tooltip: {
              backgroundColor: 'rgba(30, 41, 59, 0.95)',
              titleColor: '#fff',
              bodyColor: '#fff',
              padding: 12,
              cornerRadius: 8,
              callbacks: {
                label: (context) => `Score: ${context.parsed.y}%`
              }
            }
          },
          scales: {
            x: {
              grid: { display: false },
              ticks: {
                color: getChartColors().text,
                maxRotation: 45,
                minRotation: 45,
                font: { size: 10 }
              }
            },
            y: {
              beginAtZero: true,
              max: 100,
              grid: { color: getChartColors().grid },
              ticks: {
                color: getChartColors().text,
                callback: (value) => value + '%'
              }
            }
          }
        }
      });

      // Category Doughnut Chart
      const categoryCtx = document.getElementById('categoryChart').getContext('2d');
      const categoryColors = [
        '#6366f1', '#10b981', '#f59e0b', '#ef4444', '#8b5cf6', '#ec4899'
      ];
      const categoryChart = new Chart(categoryCtx, {
        type: 'doughnut',
        data: {
          labels: categoryLabels.length > 0 ? categoryLabels : ['No data yet'],
          datasets: [{
            data: categoryCounts.length > 0 ? categoryCounts : [1],
            backgroundColor: categoryCounts.length > 0 ? categoryColors : ['#e2e8f0'],
            borderWidth: 0,
            hoverOffset: 4
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          cutout: '65%',
          plugins: {
            legend: {
              position: 'bottom',
              labels: {
                color: getChartColors().text,
                padding: 12,
                font: { size: 11 },
                boxWidth: 12
              }
            },
            tooltip: {
              backgroundColor: 'rgba(30, 41, 59, 0.95)',
              titleColor: '#fff',
              bodyColor: '#fff',
              padding: 12,
              cornerRadius: 8,
            }
          }
        }
      });

      // Difficulty Bar Chart
      const difficultyCtx = document.getElementById('difficultyChart').getContext('2d');
      const difficultyColors = {
        'Easy': '#10b981',
        'Medium': '#f59e0b',
        'Hard': '#ef4444'
      };
      const difficultyChart = new Chart(difficultyCtx, {
        type: 'bar',
        data: {
          labels: difficultyLabels.length > 0 ? difficultyLabels : ['Easy', 'Medium', 'Hard'],
          datasets: [{
            label: 'Quizzes',
            data: difficultyCounts.length > 0 ? difficultyCounts : [0, 0, 0],
            backgroundColor: difficultyLabels.map(l => difficultyColors[l] || '#6366f1'),
            borderRadius: 6,
            barThickness: 30,
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          indexAxis: 'y',
          plugins: {
            legend: { display: false },
            tooltip: {
              backgroundColor: 'rgba(30, 41, 59, 0.95)',
              titleColor: '#fff',
              bodyColor: '#fff',
              padding: 12,
              cornerRadius: 8,
            }
          },
          scales: {
            x: {
              beginAtZero: true,
              grid: { color: getChartColors().grid },
              ticks: {
                color: getChartColors().text,
                stepSize: 1
              }
            },
            y: {
              grid: { display: false },
              ticks: {
                color: getChartColors().text,
                font: { weight: '500' }
              }
            }
          }
        }
      });

      // Update charts on theme change
      const updateChartsTheme = () => {
        const colors = getChartColors();
        [activityChart, scoreChart, categoryChart, difficultyChart].forEach(chart => {
          if (chart.options.scales?.x?.ticks) chart.options.scales.x.ticks.color = colors.text;
          if (chart.options.scales?.y?.ticks) chart.options.scales.y.ticks.color = colors.text;
          if (chart.options.scales?.x?.grid) chart.options.scales.x.grid.color = colors.grid;
          if (chart.options.scales?.y?.grid) chart.options.scales.y.grid.color = colors.grid;
          if (chart.options.plugins?.legend?.labels) chart.options.plugins.legend.labels.color = colors.text;
          chart.update();
        });
      };

      // Listen for theme changes
      const themeToggle = document.getElementById('themeToggle');
      if (themeToggle) {
        themeToggle.addEventListener('click', () => {
          // Wait for the class toggle to complete before updating charts
          setTimeout(updateChartsTheme, 150);
        });
      }

      // Also listen for the theme change at document level (in case theme.js toggles it)
      document.addEventListener('DOMContentLoaded', () => {
        // Ensure charts have correct colors after initial load
        setTimeout(updateChartsTheme, 100);
      });

      // ===== DYNAMIC CHART REFRESH FROM DATABASE =====
      const refreshChartsFromDatabase = async () => {
        try {
          const response = await fetch('{% url "quizzes:dashboard_charts_api" %}');
          const data = await response.json();

          if (data.success) {
            // Update Activity Chart
            activityChart.data.labels = data.chart_labels;
            activityChart.data.datasets[0].data = data.chart_quiz_counts;
            activityChart.update();

            // Update Score Chart
            scoreChart.data.labels = data.chart_labels;
            scoreChart.data.datasets[0].data = data.chart_scores;
            scoreChart.update();

            // Update Category Chart
            if (data.category_labels.length > 0) {
              categoryChart.data.labels = data.category_labels;
              categoryChart.data.datasets[0].data = data.category_counts;
              categoryChart.data.datasets[0].backgroundColor = categoryColors.slice(0, data.category_labels.length);
            } else {
              categoryChart.data.labels = ['No data yet'];
              categoryChart.data.datasets[0].data = [1];
              categoryChart.data.datasets[0].backgroundColor = ['#e2e8f0'];
            }
            categoryChart.update();

            // Update Difficulty Chart
            if (data.difficulty_labels.length > 0) {
              difficultyChart.data.labels = data.difficulty_labels;
              difficultyChart.data.datasets[0].data = data.difficulty_counts;
              difficultyChart.data.datasets[0].backgroundColor = data.difficulty_labels.map(l => difficultyColors[l] || '#6366f1');
            } else {
              difficultyChart.data.labels = ['Easy', 'Medium', 'Hard'];
              difficultyChart.data.datasets[0].data = [0, 0, 0];
            }
            difficultyChart.update();

            console.log('Charts refreshed from database:', data.summary);
            return true;
          }
        } catch (error) {
          console.error('Error refreshing charts:', error);
        }
        return false;
      };

      // Refresh button click handler
      const refreshBtn = document.getElementById('refreshChartsBtn');
      if (refreshBtn) {
        refreshBtn.addEventListener('click', async () => {
          refreshBtn.classList.add('loading');
          refreshBtn.disabled = true;

          await refreshChartsFromDatabase();

          setTimeout(() => {
            refreshBtn.classList.remove('loading');
            refreshBtn.disabled = false;
          }, 500);
        });
      }

      // Refresh charts when page becomes visible (user returns from quiz)
      document.addEventListener('visibilitychange', () => {
        if (document.visibilityState === 'visible') {
          refreshChartsFromDatabase();
        }
      });

      // Also refresh on page focus (backup for some browsers)
      window.addEventListener('focus', () => {
        refreshChartsFromDatabase();
      });

      // Initial refresh to ensure latest data
      setTimeout(refreshChartsFromDatabase, 1000);

      // ===== RESPONSIVE SIDEBAR TOGGLE FOR MOBILE =====
      const sidebar = document.getElementById("sidebar");
      const sidebarToggle = document.getElementById("sidebarToggle");
      const mainContent = document.querySelector(".main-content");

      // Check for saved state
      const sidebarCollapsed = localStorage.getItem("sidebarCollapsed") === "true";
      if (sidebarCollapsed) {
        sidebar.classList.add("collapsed");
        mainContent.classList.add("expanded");
      }

      // Desktop: toggle collapsed state (60px vs 260px)
      sidebarToggle.addEventListener("click", () => {
        sidebar.classList.toggle("collapsed");
        mainContent.classList.toggle("expanded");

        // Save state to localStorage
        localStorage.setItem(
          "sidebarCollapsed",
          sidebar.classList.contains("collapsed")
        );
      });

      // Mobile: toggle mobile-open state (slide in/out)
      if (window.innerWidth <= 768) {
        // Close sidebar on nav link click
        document.querySelectorAll('.nav-item').forEach(link => {
          link.addEventListener('click', () => {
            sidebar.classList.remove('mobile-open');
          });
        });

        // Close sidebar on outside click
        document.addEventListener('click', (e) => {
          if (!sidebar.contains(e.target) && !sidebarToggle.contains(e.target)) {
            sidebar.classList.remove('mobile-open');
          }
        });
      }

      // Handle window resize: switch between desktop and mobile behavior
      window.addEventListener('resize', () => {
        if (window.innerWidth > 768) {
          sidebar.classList.remove('mobile-open');
        }
      });

      // ===== END SIDEBAR TOGGLE =====
    </script>
  </body>
</html>
